<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disco Sync Pro</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: black;
  overflow: hidden;
}

#stage {
  position: fixed;
  inset: 0;
  transition: background 80ms linear;
  filter: saturate(150%);
}

.glow {
  box-shadow: inset 0 0 80px rgba(255,255,255,.4);
}

.blur {
  filter: blur(6px) saturate(200%);
}

#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,.65);
  padding: 12px;
  border-radius: 10px;
  color: white;
  font-family: system-ui;
  z-index: 10;
  width: 200px;
}

button, select {
  width: 100%;
  margin: 4px 0;
  padding: 6px;
  border-radius: 6px;
  border: none;
}

label {
  font-size: 13px;
  display: block;
}

#qr { margin-top: 6px; }
#status { font-size: 12px; opacity: .8; }
</style>
</head>

<body>

<div id="stage"></div>

<div id="ui">
  <button onclick="createRoom()">ðŸŽ§ Create Room</button>
  <input id="roomInput" placeholder="Room ID">
  <button onclick="joinRoom()">ðŸ‘¥ Join Room</button>

  <select id="mode" onchange="setMode(this.value)">
    <option value="beat">ðŸŽµ Beat Pulse</option>
    <option value="rainbow">ðŸŒˆ Rainbow</option>
    <option value="strobe">âš¡ Strobe</option>
    <option value="wave">ðŸŒŠ Wave</option>
    <option value="bass">ðŸ”Š Bass Reactive</option>
  </select>

  <label><input type="checkbox" id="vibe"> ðŸ“³ Vibration</label>
  <label><input type="checkbox" id="glow"> âœ¨ Glow</label>
  <label><input type="checkbox" id="blur"> ðŸŒ« Blur</label>

  <button onclick="toggleFullscreen()">â›¶ Fullscreen</button>

  <div id="status"></div>
  <div id="qr"></div>
</div>

<script>
/* ---------------- CORE ---------------- */
let peer, connections = [], conn;
let isDJ = false;
let analyser, data;
let lastEnergy = 0;
let currentMode = "beat";
let hue = 0;

const stage = document.getElementById("stage");

/* ---------------- ROOM ---------------- */
function genRoom() {
  return "dj-" + Math.random().toString(36).slice(2,7);
}

function createRoom() {
  const id = genRoom();
  isDJ = true;
  peer = new Peer(id);
  status("Room: " + id);
  peer.on("open", () => showQR(id));
  peer.on("connection", c => connections.push(c));
  initMic();
}

function joinRoom() {
  const id = roomInput.value.trim();
  peer = new Peer();
  peer.on("open", () => {
    conn = peer.connect(id);
    status("Connected");
    conn.on("data", applyState);
  });
}

function showQR(id) {
  qr.innerHTML = "";
  new QRCode(qr, {
    text: location.href.split("?")[0] + "?room=" + id,
    width: 128,
    height: 128
  });
}

/* ---------------- AUDIO ---------------- */
function initMic() {
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const ctx = new AudioContext();
    ctx.resume();
    analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    data = new Uint8Array(analyser.frequencyBinCount);
    ctx.createMediaStreamSource(stream).connect(analyser);
    loop();
  });
}

function beatDetect(e) {
  const beat = e > lastEnergy * 1.35;
  lastEnergy = e * 0.8 + lastEnergy * 0.2;
  return beat;
}

/* ---------------- LOOP ---------------- */
function loop() {
  requestAnimationFrame(loop);
  analyser.getByteFrequencyData(data);
  const energy = data.reduce((a,b)=>a+b)/data.length;
  const beat = beatDetect(energy);

  const state = visualEngine(energy, beat);
  applyVisual(state);
  broadcast(state);
}

/* ---------------- VISUAL ENGINE ---------------- */
function visualEngine(energy, beat) {
  hue = (hue + 1 + energy*0.02) % 360;
  let color;

  switch (currentMode) {
    case "rainbow":
      color = `hsl(${hue},100%,50%)`;
      break;

    case "strobe":
      color = beat ? "#fff" : "#000";
      break;

    case "wave":
      color = `hsl(${hue},100%,${40 + Math.sin(Date.now()/150)*20}%)`;
      break;

    case "bass":
      color = `hsl(${energy*3},100%,50%)`;
      break;

    default:
      color = beat ? `hsl(${hue},100%,60%)` : `hsl(${hue},100%,30%)`;
  }

  return { color, beat, mode: currentMode };
}

/* ---------------- APPLY ---------------- */
function applyVisual(state) {
  stage.style.background = state.color;

  stage.classList.toggle("glow", glow.checked && state.beat);
  stage.classList.toggle("blur", blur.checked && state.beat);

  if (state.beat && vibe.checked && navigator.vibrate) {
    navigator.vibrate(30);
  }
}

function applyState(state) {
  currentMode = state.mode;
  applyVisual(state);
}

/* ---------------- SYNC ---------------- */
function broadcast(state) {
  connections.forEach(c => c.send(state));
}

function setMode(m) {
  currentMode = m;
}

/* ---------------- UI ---------------- */
function toggleFullscreen() {
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
}

function status(t) {
  document.getElementById("status").innerText = t;
}

/* ---------------- AUTO JOIN ---------------- */
const q = new URLSearchParams(location.search);
if (q.get("room")) roomInput.value = q.get("room");
</script>

</body>
</html>